<html>
  <p> Take Captures </p>
  <script type="text/javascript">
    const electron = require('electron');
    const fs = require('fs-extra');

    const userDataPath = electron.remote.app.getPath('userData');
    const ipc = electron.ipcRenderer;
    const captureFrequency = 2000; // ms
    const capturesPerFolder = 60;
    let captureFolder;
    let captureInterval = null;
    let userId = null;

    const pad = (n, w) => (`${n}`.length > w ? `${n}` : `0000${n}`.slice(w * -1));

    const timeString = () => {
      const date = new Date();
      const YYYY = pad(date.getUTCFullYear(), 4);
      const MM = pad(date.getUTCMonth() + 1, 2);
      const DD = pad(date.getUTCDate(), 2);
      const hh = pad(date.getUTCHours(), 2);
      const mm = pad(date.getUTCMinutes(), 2);
      const ss = pad(date.getUTCSeconds(), 2);
      const ms = pad(date.getUTCMilliseconds(), 3);
      return `${YYYY}${MM}${DD}${hh}${mm}${ss}${ms}`;
    };

    const createCaptureFolder = () => {
      const folder = timeString();
      fs.mkdir(`${userDataPath}/Captures`, err => console.log(err));
      fs.mkdir(`${userDataPath}/Captures/${folder}`, err => console.log(err));
      captureFolder = `${userDataPath}/Captures/${folder}`;
    };

    const startOBSCapture = () => {
      createCaptureFolder();
      ipc.send('start-obs-capture', captureFolder);
      ipc.send('create-obs-display');
      captureInterval = setInterval(() => {
        const prevFolder = captureFolder;
        createCaptureFolder();
        ipc.send('update-obs-capture-folder', prevFolder, captureFolder, userId);
      }, captureFrequency * capturesPerFolder);
    };

    ipc.on('start-capture', (event, uid) => {
      if (captureInterval === null) {
        console.log('start', uid);
        userId = uid;
        startOBSCapture();
      }
    });

    ipc.on('stop-capture', () => {
      if (captureInterval) {
        console.log('stop');
        clearInterval(captureInterval);
        captureInterval = null;
        ipc.send('remove-obs-display');
        ipc.send('stop-obs-capture', captureFolder, userId);
      }
    });

    ipc.on('close', () => {
      if (captureInterval) {
        clearInterval(captureInterval);
        captureInterval = null;
        ipc.send('remove-obs-display');
        ipc.send('stop-obs-capture', captureFolder, userId);
      }
      window.close();
    });

  </script>
</html>
